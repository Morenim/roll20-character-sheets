<input type="hidden" class="tabstoggle" name="attr_sheetTab" value="core"/>

<div class="maincontainer core">
	<div class="core-first-block">
		<div class="section-logo">
			<div>
				<img class="image-logo" data-i18n-alt="logo-carbon-2185" alt="Carbon 2185 logo" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/carbon-2185-quickstart/logo.png">
			</div>
			<div class="navigation-menu">
				<button type="action" name="act_core" data-i18n="tab-core">Core</button>
				<button type="action" name="act_bio" data-i18n="tab-bio">Bio</button>
				<button type="action" name="act_exploits" data-i18n="tab-exploits">Exploits</button>
			</div>
			<div class="entry">
				<label for="character-name"><span data-i18n="label-character-name">Character Name</span>: </label>
				<input id="character-name" type="text" spellcheck="false" name="attr_character_name">
			</div>
		</div>
		<section id="section-character" class="character-details">
			<div id="block-character-class">
				<input id="character-class" type="text" spellcheck="false" name="attr_character_class" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-class" data-i18n="label-class">Class</label></div>
			</div>
			<div id="block-character-level">
				<input id="character-level" type="text" spellcheck="false" name="attr_character_level" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-level" data-i18n="label-level">Level</label></div>
			</div>
			<div id="block-character-origin">
				<input id="character-origin" type="text" spellcheck="false" name="attr_character_origin" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-origin" data-i18n="label-origin">Origin</label></div>
			</div>
			<div id="block-character-subclass">
				<input id="character-subclass" type="text" spellcheck="false" name="attr_subclass" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-subclass" data-i18n="label-subclass">Subclass</label></div>
			</div>
			<div id="block-character-age">
				<input id="character-age" type="text" spellcheck="false" name="attr_character_age" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-age" data-i18n="label-age">Age</label></div>
			</div>
			<div id="block-character-experience">
				<input id="character-experience" type="text" spellcheck="false" name="attr_character_experience" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-experience" data-i18n="label-experience">Experience</label></div>
			</div>
		</section>
	</div>
	<div class="core-second-block">
		<div>
			<section id="section-attributes">
				<!-- Group by three to make the layout that much easier. -->
				<div>
					<div class="attribute">
						<label for="attribute-strength" data-i18n="label-attribute-strength">STRENGTH</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{Strength=[[1d20 + @{strength_modifier}]]}}' name='roll_strength'><span name="attr_strength_modifier">0</span></button>
						<br>
						<input id="attribute-strength" type="number" value="10" class="attribute_score" name="attr_strength">
					</div>
					<div class="attribute">
						<label for="attribute-dexterity" data-i18n="label-attribute-dexterity">DEXTERITY</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{Dexterity=[[1d20 + @{dexterity_modifier}]]}}' name='roll_dexterity'><span name="attr_dexterity_modifier">0</span></button>
						<br>
						<input id="attribute-dexterity" type="number" value="10" class="attribute_score" name="attr_dexterity">
					</div>
					<div class="attribute">
						<label for="attribute-constitution" data-i18n="label-attribute-constitution">CONSTITUTION</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{Constitution=[[1d20 + @{constitution_modifier}]]}}' name='roll_constitution'><span name="attr_constitution_modifier">0</span></button>
						<br>
						<input id="attribute-constitution" type="number" value="10" class="attribute_score" name="attr_constitution">
					</div>
				</div>
				<div>
					<div class="attribute">
						<label for="attribute-intelligence" data-i18n="label-attribute-intelligence">INTELLIGENCE</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{Intelligence=[[1d20 + @{intelligence_modifier}]]}}' name='roll_intelligence'><span name="attr_intelligence_modifier">0</span></button>
						<br>
						<input id="attribute-intelligence" type="number" value="10" class="attribute_score" name="attr_intelligence">
					</div>
					<div class="attribute">
						<label for="attribute-technology" data-i18n="label-attribute-technology">TECHNOLOGY</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{Technology=[[1d20 + @{technology_modifier}]]}}' name='roll_technology'><span name="attr_technology_modifier">0</span></button>
						<br>
						<input id="attribute-technology" type="number" value="10" class="attribute_score" name="attr_technology">
					</div>
					<div class="attribute">
						<label for="attribute-people" data-i18n="label-attribute-people">PEOPLE</label><br>
						<button class="rollerlink2" type="roll" value='&{template:default} {{name=Ability Check}} {{People=[[1d20 + @{people_modifier}]]}}' name='roll_people'><span name="attr_people_modifier">0</span></button>
						<br>
						<input id="attribute-people" type="number" value="10" class="attribute_score" name="attr_people">
					</div>
				</div>
			</section>
		</div>
		<div>
			<section id="section-proficiency-bonus">
				<label for="proficiency-bonus" data-i18n="label-proficiency-bonus">PROFICIENCY BONUS</label><br>
				<input id="proficiency-bonus" type="number" value="2" class="attribute_mod" name="attr_proficiency_bonus">
			</section>
			<section id="section-saving-throws">
				<span id="saving-throws-header" data-i18n="header-saving-throws">SAVING THROWS</span><br>
				<input type="checkbox" name="attr_fortitude_proficiency" value="1" aria-label="Has fortitude save proficiency" aria-labelledby="saving-throws-header"> <span class="scoresp" name="attr_fortitude_bonus">0</span>
				<button type="roll" class="rollerlink" value='&{template:default} {{name=Saving Throw}} {{Fortitude Save=[[1d20 + @{fortitude_bonus}]]}}' name='roll_fort_save' data-i18n="roll-fortitude-save">Fortitude (con)</button>
				<br>
				<input type="checkbox" name="attr_reflex_proficiency" value="1" aria-label="Has reflex save proficiency"> <span class="scoresp" name="attr_reflex_bonus">0</span>
				<button type="roll" class="rollerlink" value='&{template:default} {{name=Saving Throw}} {{Reflex Save=[[1d20 + @{reflex_bonus}]]}}' name='roll_relfex_save' data-i18n="roll-reflex-save">Reflex (dex)</button>
				<br>
				<input type="checkbox" name="attr_mind_proficiency" value="1" aria-label="Has mind save proficiency"> <span class="scoresp" name="attr_mind_bonus">0</span>
				<button type="roll" class="rollerlink" value='&{template:default} {{name=Saving Throw}} {{Mind Save=[[1d20 + @{mind_bonus}]]}}' name='roll_mind_save' data-i18n="roll-mind-save">Mind (int)</button>
				<br>
			</section>
			<section id="section-skills">
				<span data-i18n="header-skills">SKILLS</span>
				<div id="block-skills">
					<div>
						<input type="checkbox" name="attr_acrobatics_proficiency" value="1" data-i18n-aria-label="aria-label-has-acrobatics-proficiency" aria-label="Has acrobatics proficiency">
						<input type="checkbox" name="attr_acrobatics_expertise" value="1" data-i18n-aria-label="aria-label-has-acrobatics-expertise" aria-label="Has acrobatics expertise">
						<span class="scoresp" name="attr_acrobatics">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Acrobatics=[[1d20 + @{acrobatics}]]}}' name='roll_ability_acrobatics' data-i18n="skill-acrobatics">Acrobatics</button>
					</div>
					<div>
						<input type="checkbox" name="attr_athletics_proficiency" value="1" data-i18n-aria-label="aria-label-has-athletics-proficiency" aria-label="Has athletics proficiency">
						<input type="checkbox" name="attr_athletics_expertise" value="1" data-i18n-aria-label="aria-label-has-athletics-expertise" aria-label="Has athletics expertise">
						<span class="scoresp" name="attr_athletics">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Athletics=[[1d20 + @{athletics}]]}}' name='roll_ability_athletics' data-i18n="skill-athletics">Athletics</button>
					</div>
					<div>
						<input type="checkbox" name="attr_bureaucracy_proficiency" value="1" data-i18n-aria-label="aria-label-has-bureaucracy-proficiency" aria-label="Has bureaucracy proficiency">
						<input type="checkbox" name="attr_bureaucracy_expertise" value="1" data-i18n-aria-label="aria-label-has-bureaucracy-expertise" aria-label="Has bureaucracy expertise">
						<span class="scoresp" name="attr_bureaucracy">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Bureaucracy=[[1d20 + @{bureaucracy}]]}}' name='roll_ability_bureaucracy' data-i18n="roll-skill-bureaucracy">Bureaucracy</button>
					</div>
					<div>
						<input type="checkbox" name="attr_computing_proficiency" value="1" data-i18n-aria-label="aria-label-has-computing-proficiency" aria-label="Has computing proficiency">
						<input type="checkbox" name="attr_computing_expertise" value="1" data-i18n-aria-label="aria-label-has-computing-expertise" aria-label="Has computing expertise">
						<span class="scoresp" name="attr_computing">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Computing=[[1d20 + @{computing}]]}}' name='roll_ability_computing' data-i18n="roll-skill-computing">Computing</button>
					</div>
					<div>
						<input type="checkbox" name="attr_deception_proficiency" value="1" data-i18n-aria-label="aria-label-has-deception-proficiency" aria-label="Has deception proficiency">
						<input type="checkbox" name="attr_deception_expertise" value="1" data-i18n-aria-label="aria-label-has-deception-expertise" aria-label="Has deception expertise">
						<span class="scoresp" name="attr_deception">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Deception=[[1d20 + @{deception}]]}}' name='roll_ability_deception' data-i18n="roll-skill-deception">Deception</button>
					</div>
					<div>
						<input type="checkbox" name="attr_engineering_proficiency" value="1" data-i18n-aria-label="aria-label-has-engineering-proficiency" aria-label="Has engineering proficiency">
						<input type="checkbox" name="attr_engineering_expertise" value="1" data-i18n-aria-label="aria-label-has-engineering-expertise" aria-label="Has engineering expertise">
						<span class="scoresp" name="attr_engineering">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Engineering=[[1d20 + @{engineering}]]}}' name='roll_ability_engineering' data-i18n="roll-skill-engineering">Engineering</button>
					</div>
					<div>
						<input type="checkbox" name="attr_gambling_proficiency" value="1" data-i18n-aria-label="aria-label-has-gambling-proficiency" aria-label="Has gambling proficiency">
						<input type="checkbox" name="attr_gambling_expertise" value="1" data-i18n-aria-label="aria-label-has-gambling-expertise" aria-label="Has gambling expertise">
						<span class="scoresp" name="attr_gambling">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Gambling=[[1d20 + @{gambling}]]}}' name='roll_ability_gambling' data-i18n="roll-skill-gambling">Gambling</button>
					</div>
					<div>
						<input type="checkbox" name="attr_hacking_proficiency" value="1" data-i18n-aria-label="aria-label-has-hacking-proficiency" aria-label="Has hacking proficiency">
						<input type="checkbox" name="attr_hacking_expertise" value="1" data-i18n-aria-label="aria-label-has-hacking-expertise" aria-label="Has hacking expertise">
						<span class="scoresp" name="attr_hacking">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Hacking=[[1d20 + @{hacking}]]}}' name='roll_ability_hacking' data-i18n="roll-skill-hacking">Hacking</button>
					</div>
					<div>
						<input type="checkbox" name="attr_history_proficiency" value="1" data-i18n-aria-label="aria-label-has-history-proficiency" aria-label="Has history proficiency">
						<input type="checkbox" name="attr_history_expertise" value="1" data-i18n-aria-label="aria-label-has-history-expertise" aria-label="Has history expertise">
						<span class="scoresp" name="attr_history">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{History=[[1d20 + @{history}]]}}' name='roll_ability_history' data-i18n="roll-skill-history">History</button>
					</div>
					<div>
						<input type="checkbox" name="attr_intimidation_proficiency" value="1" data-i18n-aria-label="aria-label-has-intimidation-proficiency" aria-label="Has intimidation proficiency">
						<input type="checkbox" name="attr_intimidation_expertise" value="1" data-i18n-aria-label="aria-label-has-intimidation-expertise" aria-label="Has intimidation expertise">
						<span class="scoresp" name="attr_intimidation">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Intimidation=[[1d20 + @{intimidation}]]}}' name='roll_ability_intimidation' data-i18n="roll-skill-intimidation">Intimidation</button>
					</div>
					<div>
						<input type="checkbox" name="attr_investigation_proficiency" value="1" data-i18n-aria-label="aria-label-has-investigation-proficiency" aria-label="Has investigation proficiency">
						<input type="checkbox" name="attr_investigation_expertise" value="1" data-i18n-aria-label="aria-label-has-investigation-expertise" aria-label="Has investigation expertise">
						<span class="scoresp" name="attr_investigation">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Investigation=[[1d20 + @{investigation}]]}}' name='roll_ability_investigation' data-i18n="roll-skill-investigation">Investigation</button>
					</div>
					<div>
						<input type="checkbox" name="attr_mechanics_proficiency" value="1" data-i18n-aria-label="aria-label-has-mechanics-proficiency" aria-label="Has mechanics proficiency">
						<input type="checkbox" name="attr_mechanics_expertise" value="1" data-i18n-aria-label="aria-label-has-mechanics-expertise" aria-label="Has mechanics expertise">
						<span class="scoresp" name="attr_mechanics">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Mechanics=[[1d20 + @{mechanics}]]}}' name='roll_ability_mechanics' data-i18n="roll-skill-mechanics">Mechanics</button>
					</div>
					<div>
						<input type="checkbox" name="attr_medicine_proficiency" value="1" data-i18n-aria-label="aria-label-has-medicine-proficiency" aria-label="Has medicine proficiency">
						<input type="checkbox" name="attr_medicine_expertise" value="1" data-i18n-aria-label="aria-label-has-medicine-expertise" aria-label="Has medicine expertise">
						<span class="scoresp" name="attr_medicine">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Medicine=[[1d20 + @{medicine}]]}}' name='roll_ability_medicine' data-i18n="roll-skill-medicine">Medicine</button>
					</div>
					<div>
						<input type="checkbox" name="attr_navigation_proficiency" value="1" data-i18n-aria-label="aria-label-has-navigation-proficiency" aria-label="Has navigation proficiency">
						<input type="checkbox" name="attr_navigation_expertise" value="1" data-i18n-aria-label="aria-label-has-navigation-expertise" aria-label="Has navigation expertise">
						<span class="scoresp" name="attr_navigation">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Navigation=[[1d20 + @{navigation}]]}}' name='roll_ability_navigation' data-i18n="roll-skill-navigation">Navigation</button>
					</div>
					<div>
						<input type="checkbox" name="attr_perception_proficiency" value="1" data-i18n-aria-label="aria-label-has-perception-proficiency" aria-label="Has perception proficiency">
						<input type="checkbox" name="attr_perception_expertise" value="1" data-i18n-aria-label="aria-label-has-perception-expertise" aria-label="Has perception expertise">
						<span class="scoresp" name="attr_perception">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Perception=[[1d20 + @{perception}]]}}' name='roll_ability_perception' data-i18n="roll-skill-perception">Perception</button>
					</div>
					<div>
						<input type="checkbox" name="attr_performance_proficiency" value="1" data-i18n-aria-label="aria-label-has-performance-proficiency" aria-label="Has performance proficiency">
						<input type="checkbox" name="attr_performance_expertise" value="1" data-i18n-aria-label="aria-label-has-performance-expertise" aria-label="Has performance expertise">
						<span class="scoresp" name="attr_performance">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Performance=[[1d20 + @{performance}]]}}' name='roll_ability_performance' data-i18n="roll-skill-performance">Performance</button>
					</div>
					<div>
						<input type="checkbox" name="attr_persuasion_proficiency" value="1" data-i18n-aria-label="aria-label-has-persuasion-proficiency" aria-label="Has persuasion proficiency">
						<input type="checkbox" name="attr_persuasion_expertise" value="1" data-i18n-aria-label="aria-label-has-persuasion-expertise" aria-label="Has persuasion expertise">
						<span class="scoresp" name="attr_persuasion">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Persuasion=[[1d20 + @{persuasion}]]}}' name='roll_ability_persuasion' data-i18n="roll-skill-persuasion">Persuasion</button>
					</div>
					<div>
						<input type="checkbox" name="attr_presence_proficiency" value="1" data-i18n-aria-label="aria-label-has-presence-proficiency" aria-label="Has presence proficiency">
						<input type="checkbox" name="attr_presence_expertise" value="1" data-i18n-aria-label="aria-label-has-presence-expertise" aria-label="Has presence expertise">
						<span class="scoresp" name="attr_presence">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Presence=[[1d20 + @{presence}]]}}' name='roll_ability_presence' data-i18n="roll-skill-presence">Presence</button>
					</div>
					<div>
						<input type="checkbox" name="attr_religion_proficiency" value="1" data-i18n-aria-label="aria-label-has-religion-proficiency" aria-label="Has religion proficiency">
						<input type="checkbox" name="attr_religion_expertise" value="1" data-i18n-aria-label="aria-label-has-religion-expertise" aria-label="Has religion expertise">
						<span class="scoresp" name="attr_religion">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Religion=[[1d20 + @{religion}]]}}' name='roll_ability_religion' data-i18n="roll-skill-religion">Religion</button>
					</div>
					<div>
						<input type="checkbox" name="attr_robotics_proficiency" value="1" data-i18n-aria-label="aria-label-has-robotics-proficiency" aria-label="Has robotics proficiency">
						<input type="checkbox" name="attr_robotics_expertise" value="1" data-i18n-aria-label="aria-label-has-robotics-expertise" aria-label="Has robotics expertise">
						<span class="scoresp" name="attr_robotics">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Robotics=[[1d20 + @{robotics}]]}}' name='roll_ability_robotics' data-i18n="roll-skill-robotics">Robotics</button>
					</div>
					<div>
						<input type="checkbox" name="attr_sensemotive_proficiency" value="1" data-i18n-aria-label="aria-label-has-sense-motive-proficiency" aria-label="Has sense motive proficiency">
						<input type="checkbox" name="attr_sensemotive_expertise" value="1" data-i18n-aria-label="aria-label-has-sense-motive-expertise" aria-label="Has sense motive expertise">
						<span class="scoresp" name="attr_sensemotive">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Sense Motive=[[1d20 + @{sensemotive}]]}}' name='roll_ability_sensemotive' data-i18n="roll-skill-sense-motive">Sense Motive</button>
					</div>
					<div>
						<input type="checkbox" name="attr_sleightofhand_proficiency" value="1" data-i18n-aria-label="aria-label-has-sleight-of-hand-proficiency" aria-label="Has sleight of hand proficiency">
						<input type="checkbox" name="attr_sleightofhand_expertise" value="1" data-i18n-aria-label="aria-label-has-sleight-of-hand-expertise" aria-label="Has sleight of hand expertise">
						<span class="scoresp" name="attr_sleightofhand">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Sleight of Hand=[[1d20 + @{sleightofhand}]]}}' name='roll_ability_sleightofhand' data-i18n="roll-skill-sleight-of-hand">Sleight of Hand</button>
					</div>
					<div>
						<input type="checkbox" name="attr_stealth_proficiency" value="1" data-i18n-aria-label="aria-label-has-stealth-proficiency" aria-label="Has stealth proficiency">
						<input type="checkbox" name="attr_stealth_expertise" value="1" data-i18n-aria-label="aria-label-has-stealth-expertise" aria-label="Has stealth expertise">
						<span class="scoresp" name="attr_stealth">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Stealth=[[1d20 + @{stealth}]]}}' name='roll_ability_stealth' data-i18n="roll-skill-stealth">Stealth</button>
					</div>
					<div>
						<input type="checkbox" name="attr_streetwise_proficiency" value="1" data-i18n-aria-label="aria-label-has-streetwise-proficiency" aria-label="Has streetwise proficiency">
						<input type="checkbox" name="attr_streetwise_expertise" value="1" data-i18n-aria-label="aria-label-has-streetwise-expertise" aria-label="Has streetwise expertise">
						<span class="scoresp" name="attr_streetwise">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Streetwise=[[1d20 + @{streetwise}]]}}' name='roll_ability_streetwise' data-i18n="roll-skill-streetwise">Streetwise</button>
					</div>
					<div>
						<input type="checkbox" name="attr_tracking_proficiency" value="1" data-i18n-aria-label="aria-label-has-tracking-proficiency" aria-label="Has tracking proficiency">
						<input type="checkbox" name="attr_tracking_expertise" value="1" data-i18n-aria-label="aria-label-has-tracking-expertise" aria-label="Has tracking expertise">
						<span class="scoresp" name="attr_tracking">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Tracking=[[1d20 + @{tracking}]]}}' name='roll_ability_tracking' data-i18n="roll-skill-tracking">Tracking</button>
					</div>
					<div>
						<input type="checkbox" name="attr_airvehicles_proficiency" value="1" data-i18n-aria-label="aria-label-has-air-vehicles-proficiency" aria-label="Has air vehicles proficiency">
						<input type="checkbox" name="attr_airvehicles_expertise" value="1" data-i18n-aria-label="aria-label-has-air-vehicles-expertise" aria-label="Has air vehicles expertise">
						<span class="scoresp" name="attr_airvehicles">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Vehicles (Air)=[[1d20 + @{airvehicles}]]}}' name='roll_ability_airvehicles' data-i18n="roll-skill-air-vehicles">Vehicles (Air)</button>
					</div>
					<div>
						<input type="checkbox" name="attr_landvehicles_proficiency" value="1" data-i18n-aria-label="aria-label-has-land-vehicles-proficiency" aria-label="Has land vehicles proficiency">
						<input type="checkbox" name="attr_landvehicles_expertise" value="1" data-i18n-aria-label="aria-label-has-land-vehicles-expertise" aria-label="Has land vehicles expertise">
						<span class="scoresp" name="attr_landvehicles">0</span>
						<button class="rollerlink" type="roll" value='&{template:default} {{name=Skill Check}} {{Vehicles (Land)=[[1d20 + @{landvehicles}]]}}' name='roll_ability_landvehicles' data-i18n="roll-skill-land-vehicles">Vehicles (Land)</button>
					</div>
				</div>
			</section>
		</div>
		<div>
			<section id="section-other-attributes">
				<div class="character-details">
					<div id="block-hitpoints">
						<input id="attribute-hitpoints" type="number" name="attr_hitpoints" class="hp" spellcheck="false"><br>
						<div class="cntrtxt"><label for="attribute-hitpoints" data-i18n="label-hit-points">Hit Points</label></div>
					</div>
					<div id="block-hitpoints-maximum">
						<input id="attribute-hitpoints-maximum" type="number" name="attr_hitpoints_max" class="hp" spellcheck="false"><br>
						<div class="cntrtxt"><label for="attribute-hitpoints-maximum" data-i18n="label-hit-points-max">HP Max</label></div>
					</div>
					<div id="block-hit-die">
						<input id="attribute-hit-die" type="number" spellcheck="false" name="attr_hit_die" class="hp">
						<div class="cntrtxt"><label for="attribute-hit-die" data-i18n="label-hit-die">Hit Die</label></div>
					</div>
					<div id="block-hit-die-roll">
						<input id="attribute-hit-die-roll" type="text" spellcheck="false" name="attr_hit_die_roll" class="hp">
						<div class="cntrtxt"><label for="attribute-hit-die-roll" data-i18n="label-hit-die-roll">Hit Die Roll</label></div>
					</div>
				</div>
				<div class="character-details">
					<div id="block-armor-class">
						<input id="attribute-armor-class" type="number" name="attr_armor_class" class="attribute_mod"><br>
						<div class="cntrtxt"><label for="attribute-armor-class" data-i18n="label-armor-class">AC</label></div>
					</div>
					<div id="block-initiative">
						<input id="initiative" type="number" spellcheck="false" name="attr_initiative" class="attribute_mod" data-i18n-aria-label="aria-label-initiative" aria-label="Initiative"><br>
						<div class="cntrtxt">
							<button type="roll" class="rollerlink inline-roll-button" value='&{template:default} {{name=@{character_name}}} {{Initiative=[[1d20 + @{initiative} &{tracker}]]}}' name='roll_initiative' data-i18n="roll-initiative">Initiative</button>
						</div>
					</div>
					<div id="block-speed">
						<input id="attribute-speed" type="number" spellcheck="false" name="attr_speed" class="attribute_mod"><br>
						<div class="cntrtxt"><label for="attribute-speed" data-i18n="label-speed">Speed</label></div>
					</div>
					<div id="block-inspiration">
						<input id="inspiration" type="checkbox" name="attr_inspiration">
						<div class="cntrtxt"><label for="inspiration" data-i18n="label-inspiration">Inspiration:</label></div>
					</div>
				</div>
			</section>
			<div id="block-attacks-and-resources">
				<div>
					<section id="section-attacks">
						<div id="header-attacks">
							<span class="attack-name" data-i18n="abbreviation-attack-name">Name</span>
							<span class="attack-bonus" data-i18n="abbreviation-attack-bonus">Hit</span>
							<span class="attack-damage" data-i18n="abbreviation-attack-damage">Dmg</span>
						</div>
						<fieldset class="repeating_attack">
							<div class="attack">
								<div class="display">
									<input type="hidden" name="attr_rollcontent" value="value='&{template:default} {{name=Attack}} {{Weapon=@{attackname}}} {{Damage Type=@{attackdamagetype}}} {{Attack Roll 1 =[[1d20 + @{attackbonus}]]}} {{Attack Roll 2 =[[1d20 + @{attackbonus}]]}} {{Damage Roll=[[@{attackdamage}]]}}' name='roll_attack_1'">
									<button type="roll" name="roll_attack" value="@{rollcontent}">
										<span class="attack-name" name="attr_attackname"></span>
										<span class="attack-bonus"><span name="attr_attackbonus"></span></span>
										<span class="attack-damage"><span name="attr_attackdamage"></span> <span name="attr_attackdamagetype"></span></span>
									</button>
								</div>
								<input class="details-flag" type="checkbox" name="attr_details-flag" checked="checked"/><span>y</span>
								<div class="details">
									<label><span data-i18n="label-attack-name">Name</span>: <input type="text" spellcheck="false" name="attr_attackname"></label>
									<label><span data-i18n="label-attack-bonus">Attack</span>: <input type="text" spellcheck="false" name="attr_attackbonus"></label>
									<label><span data-i18n="label-attack-damage">Damage</span>: <input type="text" name="attr_attackdamage" placeholder="1d6"></label>
									<label><span data-i18n="label-attack-damage-type">Type</span>: <input type="text" name="attr_attackdamagetype" data-i18n-placeholder="placeholder-attack-damage-type" placeholder="Ballistic"></label>
									<label><span data-i18n="label-attack-range">Range</span>: <input type="text" name="attr_attackrange" placeholder="60-foot"></label>
								</div>
							</div>
						</fieldset>
						<div class="section-title" data-i18n="header-attacks">ATTACKS</div>
					</section>
				</div>
				<div>
					<section id="section-resources">
						<fieldset class="repeating_resources">
							<div class="resource">
								<label><span data-i18n="label-resource-max-uses">Total</span>: <input type="number" name="attr_resourcemax" value="0" class="w10" aria-label="Resource maximum value"></label>
								<input type="number" name="attr_resourcecurrent" value="0" aria-label="Resource current value">
								<input type="text" spellcheck="false" name="attr_resourcetype" data-i18n-placeholder="placeholder-resource-type" placeholder="Class resource">
							</div>
							<div class="resource">
								<label><span data-i18n="label-resource-max-uses">Total</span>: <input type="number" name="attr_resourceothermax" value="0" class="w10" aria-label="Resource maximum value"></label>
								<input type="number" name="attr_resourceothercurrent" value="0" aria-label="Resource current value">
								<input type="text" spellcheck="false" name="attr_resourceothertype" data-i18n-placeholder="placeholder-resource-type" placeholder="Class resource" size="5">
							</div>
						</fieldset>
						<div class="section-title" data-i18n="header-resource-tracker">RESOURCE TRACKER</div>
					</section>
				</div>
			</div>
			<section id="section-ammo-tracker">
				<div id="header-ammo-tracker">
					<span id="ammo-name" class="ammo-name" data-i18n="abbreviation-ammo-name">Ammo</span>
					<span id="ammo-clip-type" class="ammo-clip-type" data-i18n="abbreviation-ammo-clip-type">Weapon clip</span>
					<span id="ammo-slot" class="ammo-slot" data-i18n="abbreviation-ammo-slot">Location</span>
					<span id="ammo-current" class="ammo-current" data-i18n="abbreviation-ammo-current">Current</span>
					<span id="ammo-max" class="ammo-max" data-i18n="abbreviation-ammo-max">Max</span>
				</div>
				<fieldset class="repeating_ammo">
					<input type="text" spellcheck="false" name="attr_ammotype" class="ammo-name">
					<input type="text" spellcheck="false" name="attr_ammocliptype" class="ammo-clip-type">
					<input type="text" spellcheck="false" name="attr_ammoslot" class="ammo-slot">
					<input type="number" name="attr_ammocurrent" class="ammo-current">
					<input type="number" name="attr_ammomax" class="ammo-max">
				</fieldset>
				<div class="section-title" data-i18n="header-ammo-tracker">AMMO TRACKER</div>
			</section>
			<section id="section-proficiencies">
				<table>
					<tr>
						<td><label for="armor-proficiency">Armor:</label></td>
						<td class="w100"><input id="armor-proficiency" type="text" spellcheck="false" name="attr_armor_proficiency_slot" class="w100"></td>
					</tr>
					<tr>
						<td><label for="weapon-proficiency">Weapons:</label></td>
						<td class="w100"><input id="weapon-proficiency" type="text" spellcheck="false" name="attr_weapon_proficiency_slot" class="w100"></td>
					</tr>
					<tr>
						<td><label for="tools-proficiency">Tools:</label></td>
						<td class="w100"><input id="tools-proficiency" type="text" spellcheck="false" name="attr_tools_proficiency_slot" class="w100" aria-label="Tools proficiency 1"></td>
					</tr>
					<tr>
						<td></td>
						<td class="w100"><input type="text" spellcheck="false" name="attr_languages_tools_2_slot" class="w100" aria-label="Tools proficiency 2"></td>
					</tr>
					<tr>
						<td><label for="language-proficiency">Languages:</label></td>
						<td class="w100"><input id="language-proficiency" type="text" spellcheck="false" name="attr_languages_proficiency_slot" class="w100" aria-label="Language proficiency 1"></td>
					</tr>
					<tr>
						<td></td>
						<td class="w100"><input type="text" spellcheck="false" name="attr_languages_proficiency_2_slot" class="w100" aria-label="Language proficiency 2"></td>
					</tr>
				</table>
				<div class="section-title" data-i18n="header-proficiencies-and-languages">PROFICIENCIES AND LANGUAGES</div>
			</section>
		</div>
	</div>
	<div class="core-third-block">
		<section id="section-gear">
			<div id="header-gear">
				<div id="block-currency-wonlong">
					<input id="currency-wonlongs" type="text" spellcheck="false" name="attr_wonlongs" class="w90 inpcntr">
					<div class="cntrtxt"><label for="currency-wonlongs" data-i18n="label-wonlongs">Wonlongs</label></div>
				</div>
				<div id="block-influence-street">
					<input id="influence-street" type="text" spellcheck="false" name="attr_influence_street" class="w90 inpcntr">
					<div class="cntrtxt"><label for="influence-street" data-i18n="label-influence-street">Infl. Street</label></div>
				</div>
				<div id="block-influence-corporate">
					<input id="influence-corporate" type="text" spellcheck="false" name="attr_influence_corporate" class="w90 inpcntr">
					<div class="cntrtxt"><label for="influence-corporate" data-i18n="label-influence-corporate">Infl. Corporate</label></div>
				</div>
				<div id="block-totalweight">
					<input id="totalweight" type="text" spellcheck="false" name="attr_combitemweight" class="w90 inpcntr" readonly>
					<div class="cntrtxt"><label for="totalweight" data-i18n="label-total-weight">Total weight</label></div>
				</div>
			</div>
			<fieldset class="repeating_inventory">
				<input type="checkbox" name="attr_itemequipped" value="1">
				<input type="number" spellcheck="false" name="attr_itemcount" value="1" class="w25p">
				<input type="text" class="item-name" spellcheck="false" name="attr_itemname" class="w80">
				<input type="number" spellcheck="false" name="attr_itemweight" value="0" class="w25p">
			</fieldset>
			<div class="section-title" data-i18n="header-gear">GEAR</div>
		</section>
		<section id="section-augmentations">
			<div id="header-augmentations">
				<span id="augmentation-slot" class="augmentation-slot" data-i18n="abbreviation-augmentation-slot">Slot</span>
				<span id="augmentation-name" class="augmentation-name" data-i18n="abbreviation-augmentation-name">Name</span>
				<span id="augmentation-blood-toxicity" class="augmentation-blood-toxicity" data-i18n="abbreviation-augmentation-blood-toxicity">Tox</span>
			</div>
			<fieldset class="repeating_augmentation">
				<input type="text" spellcheck="false" name="attr_augmentationslot" class="augmentation-slot">
				<input type="text" spellcheck="false" name="attr_augmentationname" class="augmentation-name">
				<input type="number" name="attr_augmentationbloodtoxicity" value="0" class="augmentation-blood-toxicity">
			</fieldset>
			<label><span data-i18n="label-total-blood-toxicity">Total blood toxicity</span>: <input type="number" name="attr_bloodtoxicity" placeholder="weight" readonly></label>
			<div class="section-title" data-i18n="header-augmentations">AUGMENTATIONS</div>
		</section>
		<section id="section-feats" class="textbox">
			<textarea id="feats-and-abilities" name='attr_info'></textarea>
			<span class="section-title"><label for="feats-and-abilities" data-i18n="header-feats-and-abilities">FEATS AND ABILITIES</label></span>
		</section>
	</div>

	<input type="hidden" name="attr_athletics" value="0">
	<input type="hidden" name="attr_intimidation" value="0">
	<input type="hidden" name="attr_acrobatics" value="0">
	<input type="hidden" name="attr_sleightofhand" value="0">
	<input type="hidden" name="attr_stealth" value="0">
	<input type="hidden" name="attr_landvehicles" value="0">
	<input type="hidden" name="attr_bureaucracy" value="0">
	<input type="hidden" name="attr_deception" value="0">
	<input type="hidden" name="attr_performance" value="0">
	<input type="hidden" name="attr_pursuasion" value="0">
	<input type="hidden" name="attr_presence" value="0">
	<input type="hidden" name="attr_sensemotive" value="0">
	<input type="hidden" name="attr_computing" value="0">
	<input type="hidden" name="attr_hacking" value="0">
	<input type="hidden" name="attr_mechanics" value="0">
	<input type="hidden" name="attr_medicine" value="0">
	<input type="hidden" name="attr_robotics" value="0">
	<input type="hidden" name="attr_airvehicles" value="0">
	<input type="hidden" name="attr_engineering" value="0">
	<input type="hidden" name="attr_gambling" value="0">
	<input type="hidden" name="attr_history" value="0">
	<input type="hidden" name="attr_investigation" value="0">
	<input type="hidden" name="attr_navigation" value="0">
	<input type="hidden" name="attr_perception" value="0">
	<input type="hidden" name="attr_religion" value="0">
	<input type="hidden" name="attr_streetwise" value="0">
	<input type="hidden" name="attr_tracking" value="0">

</div>

<div class="maincontainer bio">
	<div class="core-first-block">
		<div class="section-logo">
			<div>
				<img class="image-logo" data-i18n-alt="logo-carbon-2185" alt="Carbon 2185 logo" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/carbon-2185-quickstart/logo.png">
			</div>
			<div class="navigation-menu">
				<button type="action" name="act_core" data-i18n="tab-core">Core</button>
				<button type="action" name="act_bio" data-i18n="tab-bio">Bio</button>
				<button type="action" name="act_exploits" data-i18n="tab-exploits">Exploits</button>
			</div>
		</div>
		<section id="section-character-details" class="character-details">
			<div class="block-character-height">
				<input id="character-height" type="text" spellcheck="false" name="attr_character_height" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-height" data-i18n="label-height">Height</label></div>
			</div>
			<div class="block-character-weight">
				<input id="character-weight" type="text" spellcheck="false" name="attr_character_weight" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-weight" data-i18n="label-weight">Weight</label></div>
			</div>
			<div class="block-character-hair">
				<input id="character-hair" type="text" spellcheck="false" name="attr_character_hair" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-hair" data-i18n="label-hair">Hair</label></div>
			</div>
			<div class="block-character-eyes">
				<input id="character-eyes" type="text" spellcheck="false" name="attr_character_eyes" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-eyes" data-i18n="label-eyes">Eyes</label></div>
			</div>
			<div class="block-character-skin">
				<input id="character-skin" type="text" spellcheck="false" name="attr_character_skin" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-skin" data-i18n="label-skin">Skin</label></div>
			</div>
			<div class="block-character-religion">
				<input id="character-religion" type="text" spellcheck="false" name="attr_character_religion" class="w90 inpcntr">
				<div class="cntrtxt"><label for="character-religion" data-i18n="label-skin">Religion</label></div>
			</div>
		</section>
	</div>
	<div id="block-bio">
		<section id="section-notes" class="textbox">
			<textarea id="notes" name='attr_notes'></textarea>
			<div class="section-title"><label for="notes" data-i18n="header-notes">NOTES</label></div>
		</section>
		<section id="section-career">
			<div id="header-career">
				<span id="career-header" class="career-name" data-i18n="header-career-name">Career</span>
				<span id="years-header" class="career-years" data-i18n="header-career-years">Years</span>
			</div>
			<fieldset class="repeating_career">
				<input type="text" name="attr_careername" class="career-name" aria-labelledby="header-career-name" aria-label="Career header">
				<input type="text" name="attr_careeryears" class="career-years"  aria-labelledby="header-career-years" aria-label="Career years"><br>
			</fieldset>
		</section>
		<section id="section-vice" class="textbox">
			<textarea id="character-vice" name='attr_vice'></textarea>
			<div class="section-title"><label for="character-vice" data-i18n="header-vice">VICE</label></div>
		</section>
		<section id="section-backstory" class="textbox">
			<textarea id="character-backstory" name='attr_backstory'></textarea>
			<div class="section-title"><label for="character-backstory" data-i18n="header-backstory">BACKSTORY</label></div>
		</section>
		<section id="section-relationships" class="textbox">
			<textarea id="character-relationships" name='attr_relationships'></textarea>
			<div class="section-title"><label for="character-relationships" data-i18n="header-relationships">RELATIONSHIPS</label></div>
		</section>
	</div>
</div>

<div class="maincontainer exploits">
	<div class="core-first-block">
		<div class="section-logo">
			<div>
				<img class="image-logo" data-i18n-alt="logo-carbon-2185" alt="Carbon 2185 logo" src="https://raw.githubusercontent.com/Roll20/roll20-character-sheets/master/carbon-2185-quickstart/logo.png">
			</div>
			<div class="navigation-menu">
				<button type="action" name="act_core" data-i18n="tab-core">Core</button>
				<button type="action" name="act_bio" data-i18n="tab-bio">Bio</button>
				<button type="action" name="act_exploits" data-i18n="tab-exploits">Exploits</button>
			</div>
		</div>
		<section id="section-exploits-details" class="character-details">
			<div class="block-exploit-save-dc">
				<input id="exploit-save-dc" readonly type="number" spellcheck="false" name="attr_exploit_savedc" class="w90 inpcntr">
				<div class="cntrtxt"><label for="exploit-save-dc" data-i18n="label-exploit-save-dc">Save DC</label></div>
			</div>
			<div class="block-exploit-uses">
				<input id="exploit-uses" type="number" spellcheck="false" name="attr_exploit_uses" class="w90 inpcntr">
				<div class="cntrtxt"><label for="exploit-uses" data-i18n="label-exploit-uses">Uses</label></div>
			</div>
			<div class="block-exploit-max-uses">
				<input id="exploit-max-uses" type="number" spellcheck="false" name="attr_exploit_maxuses" class="w90 inpcntr">
				<div class="cntrtxt"><label for="exploit-max-uses" data-i18n="label-exploit-max-uses">Max uses</label></div>
			</div>
		</section>
	</div>
	<div class="exploits-second-block">
		<section id="section-exploits">
			<fieldset class="repeating_exploit">
				<div class="exploit">
					<div class="display">
						<input type="hidden" name="attr_rollcontent" value="&{template:exploit} {{name=@{exploitname}}} {{range=@{exploitrange}}} {{duration=@{exploitduration}}} {{description=@{exploitdescription}}}">
						<button type="roll" name="roll_exploit" value="@{rollcontent}">
							<span class="exploit-name" name="attr_exploitname"></span>
							<span class="exploit-range" name="attr_exploitrange"></span>
							<span class="exploit-duration" name="attr_exploitduration"></span>
						</button>
					</div>
					<input class="details-flag" type="checkbox" name="attr_details-flag" checked="checked"/><span>i</span>
					<div class="details">
						<div>
							<label><span data-i18n="label-exploit-name">Name</span>: <input type="text" name="attr_exploitname"></label>
							<label><span data-i18n="label-exploit-range">Range</span>: <input type="text" name="attr_exploitrange"></label>
							<label><span data-i18n="label-exploit-duration">Duration</span>: <input type="text" name="attr_exploitduration"></label>
						</div>
						<label><span data-i18n="label-exploit-description">Description</span>: <textarea name="attr_exploitdescription"></textarea></label>
					</div>
				</div>
			</fieldset>
		</section>
	</div>
</div>

<div class="rolltemplates" style="display: none">
	<rolltemplate class="sheet-rolltemplate-exploit">
		<div class="sheet-template-container">
			<div class="sheet-template-header">{{name}}</div>
			<div class="sheet-template-row"><span data-i18n="roll-template-exploit-range">Range</span>: {{range}}</div>
			<div class="sheet-template-row"><span data-i18n="roll-template-exploit-duration">Duration</span>: {{duration}}</div>
			<div class="sheet-template-row">{{description}}</div>
		</div>
	</rolltemplate>
</div>

<input type="hidden" name="attr_majorVersion" value="1"/>
<input type="hidden" name="attr_minorVersion" value="0"/>
<input type="hidden" name="attr_patchVersion" value="0"/>

<script type="text/worker">

/* ===== PARAMETERS ==========
destinations = the name of the attribute that stores the total quantity
        can be a single attribute, or an array: ['total_cost', 'total_weight']
        If more than one, the matching fields must be in the same order.
    section = name of repeating fieldset, without the repeating_
    fields = the name of the attribute field to be summed
          destination and fields both can be a single attribute: 'weight'
          or an array of attributes: ['weight','number','equipped']
*/
const repeatingSum = (destinations, section, fields) => {
    if (!Array.isArray(destinations)) destinations = [destinations.replace(/\s/g, '').split(',')];
    if (!Array.isArray(fields)) fields = [fields.replace(/\s/g, '').split(',')];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = {};
            destinations.forEach((destination, index) => {
                output[destination] = idArray.reduce((total, id) => total + getValue(section, id, fields[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * getValue(section, id, mult), 1), 0);
            });
            setAttrs(output);
        });
    });
};

function toChangeSelector(xs, suffixes) {
	return xs.flatMap(x => suffixes.map(suffix => suffix ? `change:${x}_${suffix}` : `change:${x}`)).join(' ');
}

function toAttrGetters(xs, suffixes) {
	return xs.flatMap(x => suffixes.map(suffix => suffix ? `${x}_${suffix}` : x));
}

function num(values, s) {
	return parseInt(values[s]) || 0;
}

function rangeOfIndexes(n) {
	return Array.from({ length: n }, (x, i) => i + 1);
}

const attributes = [
	'strength',
	'dexterity',
	'constitution',
	'technology',
	'intelligence',
	'people'
];

const saves = [
	{ name: 'mind', attribute: 'intelligence' },
	{ name: 'fortitude', attribute: 'constitution' },
	{ name: 'reflex', attribute: 'dexterity' }
];

const skills = [
	{ name: 'acrobatics', attribute: 'dexterity' },
	{ name: 'athletics', attribute: 'strength' },
	{ name: 'bureaucracy', attribute: 'people' },
	{ name: 'computing', attribute: 'technology' },
	{ name: 'deception', attribute: 'people' },
	{ name: 'engineering', attribute: 'technology' },
	{ name: 'gambling', attribute: 'intelligence' },
	{ name: 'hacking', attribute: 'technology' },
	{ name: 'history', attribute: 'intelligence' },
	{ name: 'intimidation', attribute: 'strength' },
	{ name: 'investigation', attribute: 'intelligence' },
	{ name: 'mechanics', attribute: 'technology' },
	{ name: 'medicine', attribute: 'technology' },
	{ name: 'navigation', attribute: 'intelligence' },
	{ name: 'perception', attribute: 'intelligence' },
	{ name: 'performance', attribute: 'people' },
	{ name: 'persuasion', attribute: 'people' },
	{ name: 'presence', attribute: 'people' },
	{ name: 'religion', attribute: 'intelligence' },
	{ name: 'robotics', attribute: 'technology' },
	{ name: 'sensemotive', attribute: 'people' },
	{ name: 'sleightofhand', attribute: 'dexterity' },
	{ name: 'stealth', attribute: 'dexterity' },
	{ name: 'streetwise', attribute: 'intelligence' },
	{ name: 'tracking', attribute: 'intelligence' },
	{ name: 'airvehicles', attribute: 'technology' },
	{ name: 'landvehicles', attribute: 'dexterity' }
];

// Update the attribute modifiers based on the attributes.
on('sheet:opened change:proficiency_bonus ' + toChangeSelector(attributes, ['']), () => {
	getAttrs(["proficiency_bonus", ...attributes], values => {
		const attrs = {};
		attributes.forEach(attribute => {
			attrs[`${attribute}_modifier`] = Math.max(Math.floor(num(values, attribute) / 2) - 5, -2);
		});
		setAttrs(attrs);
	});
});

// Update the saving throws based on their checkboxes and attribute modifiers.
on('sheet:opened change:proficiency_bonus ' + toChangeSelector(saves.map(save => save.name), ['proficiency']) + ' ' + toChangeSelector(saves.map(save => save.attribute), ['modifier']), () => {
	getAttrs(["proficiency_bonus", ...saves.map(save => `${save.name}_proficiency`), ...saves.map(save => `${save.attribute}_modifier`)], values => {
		const attrs = {};
		const proficiencyBonus = num(values, 'proficiency_bonus');
		saves.forEach(save => {
			const isSaveChecked = num(values, `${save.name}_proficiency`) === 1;
			const attributeModifier = num(values, `${save.attribute}_modifier`);
			attrs[`${save.name}_bonus`] = attributeModifier + (isSaveChecked ? proficiencyBonus : 0);
		});
		setAttrs(attrs);
	});
});

// Calculate the total weight of the inventory.
on("change:repeating_augmentation remove:repeating_augmentation", function() {
   repeatingSum('bloodtoxicity', 'augmentation', 'augmentationbloodtoxicity');
});

// Update save DC for exploits.
on('sheet:opened change:proficiency_bonus change:technology_modifier', () => {
	getAttrs(["proficiency_bonus", "technology_modifier"], values => {
		const proficiencyBonus = num(values, 'proficiency_bonus');
		const technologyModifier = num(values, 'technology_modifier');
		setAttrs({
			exploit_savedc: 8 + proficiencyBonus + technologyModifier
		});
	});
});

// Update the skill bonusses based on their checkboxes (proficiency and expertise), proficiency bonus, and their corresponding attribute modifiers.
on('sheet:opened change:proficiency_bonus ' + toChangeSelector(attributes, ['modifier']) + ' ' + toChangeSelector(skills.map(skill => skill.name), ['proficiency', 'expertise']), () => {
	getAttrs(["proficiency_bonus", ...toAttrGetters(attributes, ['modifier']), ...toAttrGetters(skills.map(skill => skill.name), ['proficiency', 'expertise'])], values => {

		const proficiencyBonus = num(values, 'proficiency_bonus');
		const attrs = {};

		skills.forEach(skill => {
			attrs[skill.name] = num(values, `${skill.attribute}_modifier`)
				+ (num(values, `${skill.name}_proficiency`) === 1 ? proficiencyBonus : 0)
				+ (num(values, `${skill.name}_expertise`) === 1 ? proficiencyBonus : 0);
		});

		setAttrs(attrs);
	});
});

// Calculate the total weight of the inventory.
on("change:repeating_inventory remove:repeating_inventory", function() {
   repeatingSum('combitemweight', 'inventory', ['itemcount', 'itemweight']);
});

// Configure the tabs.
["core","bio","exploits"].forEach(button => {
	on(`clicked:${button}`, function() {
		setAttrs({
			sheetTab: button
		});
	});
});

// Use semantic version (https://semver.org/).
const latestVersion = [2, 0, 0];

// Upgrade the character once the sheet has been opened.
on("sheet:opened", function() {

	const itemArray = rangeOfIndexes(39);
	const attackArray = rangeOfIndexes(4);
	const resourceArray = rangeOfIndexes(4);
	const augmentationArray = rangeOfIndexes(9);
	const ammoArray = rangeOfIndexes(5);
	const careerArray = rangeOfIndexes(4);

	let attr_upgrade_selector = ["majorVersion", "minorVersion", "patchVersion"]
		// Data for upgrade 1.0.0 -> 2.0.0
		.concat(itemArray.flatMap(x => [`item${x}weight`, `equipped${x}`, `item${x}`]))
		.concat(attackArray.flatMap(x => [`attack_name_${x}`, `attack_bonus_${x}`, `attack_damage_${x}`, `attack_dmod_${x}`, `attack_type_${x}`]))
		.concat(resourceArray.flatMap(x => [`resource_${x}_type`, `resource_${x}_current`, `resource_${x}_max`]))
		.concat(augmentationArray.flatMap(x => [`augmentation_${x}_slot`, `augmentation_${x}`, `bloodtox${x}`]))
		.concat(ammoArray.flatMap(x => [`ammo_${x}_type`, `ammo_${x}_cliptype`, `ammo_${x}_slot`, `ammo_${x}_current`, `ammo_${x}_max`]))
		.concat(careerArray.flatMap(x => [`career${x}_name`, `career${x}_years`]));

	getAttrs(attr_upgrade_selector, function(values) {
		const version = [values.majorVersion, values.minorVersion, values.patchVersion].map(v => parseInt(v));

		console.log("Current character sheet version: " + version, values);

		if (version === latestVersion) {
			return;
		}

		const attrs = {};

		if (version <= [1, 0, 0]) {

			// Migrate the items.
			for (const item of itemArray) {
				const itemEquipped = values[`equipped${item}`];
				const itemWeight = values[`item${item}weight`];
				const itemName = values[`item${item}`];

				if ((itemEquipped && itemEquipped !== "0") || (itemWeight && itemWeight !== "0") || itemName) {
					const rowId = generateRowID();

					attrs[`repeating_inventory_${rowId}_itemname`] = itemName || "";
					attrs[`repeating_inventory_${rowId}_itemweight`] = itemWeight || "";
					attrs[`repeating_inventory_${rowId}_itemequipped`] = itemEquipped || "";
				}
			}

			// Migrate the attacks.
			for (const attack of attackArray) {
				const attackName = values[`attack_name_${attack}`];
				const attackBonus = values[`attack_bonus_${attack}`];
				const attackDamage = values[`attack_damage_${attack}`];
				const attackDamageModifier = values[`attack_dmod_${attack}`];
				const attackType = values[`attack_type_${attack}`];

				if (attackName || attackBonus || attackDamage || attackDamageModifier || attackType) {
					const rowId = generateRowID();
					attrs[`repeating_attack_${rowId}_attackname`] = attackName || "";
					attrs[`repeating_attack_${rowId}_attackbonus`] = attackBonus || "";
					attrs[`repeating_attack_${rowId}_attackdamage`] = (attackDamage || "") + (attackDamageModifier ? '+' + (attackDamageModifier || "") : "");
					attrs[`repeating_attack_${rowId}_attackdamagetype`] = attackType || "";
				}
			}

			// Migrate resources
			for (let i = 0; i < resourceArray.length / 2; i++) {
				const resource = i * 2 + 1;
				const resourceType = values[`resource_${resource}_type`];
				const resourceCurrent = values[`resource_${resource}_current`];
				const resourceMax = values[`resource_${resource}_max`];

				const otherResource = i * 2 + 2;
				const resourceOtherType = values[`resource_${otherResource}_type`];
				const resourceOtherCurrent = values[`resource_${otherResource}_current`];
				const resourceOtherMax = values[`resource_${otherResource}_max`];

				const hasResource = resourceOtherType || resourceOtherCurrent || resourceOtherMax;
				const hasOtherResource = resourceOtherType || resourceOtherCurrent || resourceOtherMax;

				if (hasResource || hasOtherResource) {
					const rowId = generateRowID();

					if (hasResource) {
						attrs[`repeating_resources_${rowId}_resourcetype`] = resourceType || "";
						attrs[`repeating_resources_${rowId}_resourcecurrent`] = resourceCurrent || "";
						attrs[`repeating_resources_${rowId}_resourcemax`] = resourceMax || "";
					}

					if (hasOtherResource) {
						attrs[`repeating_resources_${rowId}_resourceothertype`] = resourceOtherType || "";
						attrs[`repeating_resources_${rowId}_resourceothercurrent`] = resourceOtherCurrent || "";
						attrs[`repeating_resources_${rowId}_resourceothermax`] = resourceOtherMax || "";
					}
				}
			}

			// Migrate augmentations
			for (const augmentation of augmentationArray) {
				const augmentationSlot = values[`augmentation_${augmentation}_slot`];
				const augmentationName = values[`augmentation_${augmentation}`];
				const augmentationBloodToxicity = values[`bloodtox${augmentation}`];

				if (augmentationSlot || augmentationName || (augmentationBloodToxicity && augmentationBloodToxicity !== "0")) {
					const rowId = generateRowID();
					attrs[`repeating_augmentation_${rowId}_augmentationslot`] = augmentationSlot || "";
					attrs[`repeating_augmentation_${rowId}_augmentationname`] = augmentationName || "";
					attrs[`repeating_augmentation_${rowId}_augmentationbloodtoxicity`] = augmentationBloodToxicity || "";
				}
			}

			// Migrate ammo
			for (const ammo of ammoArray) {
				const ammoType = values[`ammo_${ammo}_type`];
				const ammoClipType = values[`ammo_${ammo}_cliptype`];
				const ammoSlot = values[`ammo_${ammo}_slot`];
				const ammoCurrent = values[`ammo_${ammo}_current`];
				const ammoMax = values[`ammo_${ammo}_max`];

				if (ammoType || ammoClipType || ammoSlot || ammoCurrent || ammoMax) {
					const rowId = generateRowID();
					attrs[`repeating_ammo_${rowId}_ammotype`] = ammoType || "";
					attrs[`repeating_ammo_${rowId}_ammocliptype`] = ammoClipType || "";
					attrs[`repeating_ammo_${rowId}_ammoslot`] = ammoSlot || "";
					attrs[`repeating_ammo_${rowId}_ammocurrent`] = ammoCurrent || "";
					attrs[`repeating_ammo_${rowId}_ammomax`] = ammoMax || "";
				}
			}

			// Migrate careers
			for (const career of careerArray) {
				const careerName = values[`career${career}_name`];
				const careerYears = values[`career${career}_years`];

				if (careerName || careerYears) {
					const rowId = generateRowID();
					attrs[`repeating_career_${rowId}_careername`] = careerName || "";
					attrs[`repeating_career_${rowId}_careeryears`] = careerYears || "";
				}
			}
		}

		if (Object.keys(attrs).length) {
			attrs.majorVersion = latestVersion[0];
			attrs.minorVersion = latestVersion[1];
			attrs.patchVersion = latestVersion[2];
			setAttrs(attrs);
		}
	});
});



</script>